<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dropbox PDF — Hardened Fullscreen Viewer</title>

<!-- ========== CONFIG ========== -->
<script>
  // Replace with your Dropbox iframe URL (the one you said works)
  const IFRAME_SRC = "https://www.dropbox.com/scl/fi/fraizb3xwx6jcmd9307xq/693101df095ae9fd19fea697.pdf?rlkey=38p2ukkfqlrfcwfiv7itk4vob&raw=1";
  // Per-customer watermark string (set server-side ideally)
  const WATERMARK_BASE = "Purchased by: user@example.com — order #12345";
  // Mask width/height (adjust if Dropbox UI layout differs)
  const TOOLBAR_MASK_WIDTH_PX = Math.max(180, Math.floor(window.innerWidth * 0.20));
  const TOOLBAR_MASK_HEIGHT_PX = Math.max(64, Math.floor(window.innerHeight * 0.07));
</script>
<!-- ========== end config ========== -->

<style>
  :root { --bg: #000; --wm-opacity: 0.08; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#fff}
  #app{position:fixed;inset:0;display:flex;align-items:stretch;justify-content:center;background:#000}
  #frameWrap{position:relative;flex:1;overflow:hidden;background:#000}
  iframe#pdfFrame{
    position:absolute; inset:0; width:100%; height:100%; border:0; background:#111;
    /* keep interactive so user can scroll/zoom */
    pointer-events: auto;
  }

  /* big top-right toolbar mask: covers and blocks clicks to toolbar area */
  #toolbarMask {
    position:absolute;
    top:0;
    right:0;
    z-index:60;
    background:linear-gradient(90deg, rgba(0,0,0,1), rgba(0,0,0,0.6));
    pointer-events:auto; /* capture clicks */
    width: var(--maskWpx);
    height: var(--maskHpx);
    border-bottom-left-radius:12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  }

  /* full overlay that captures contextmenu/middle-clicks on entire viewer */
  #interactionCatcher {
    position:absolute; inset:0; z-index:50; pointer-events:none; /* default: let iframe be interactive */
  }

  /* watermark */
  #watermark {
    position:absolute; inset:0; z-index:70; pointer-events:none; overflow:hidden;
  }
  .wmText { position:absolute; transform:rotate(-30deg); opacity:var(--wm-opacity); white-space:nowrap; user-select:none; font-size:18px; color:#fff; }

  /* controls - minimal, initially visible so user can fullscreen */
  #controls {
    position:absolute; left:12px; top:12px; z-index:80; display:flex; gap:8px; align-items:center;
  }
  button.ctrl { background:rgba(0,0,0,0.6); color:#fff; border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:6px; cursor:pointer; font-size:13px; }
  #hint { position:absolute; right:12px; top:12px; z-index:80; color:#ddd; background:rgba(0,0,0,0.4); padding:6px 8px; border-radius:6px; font-size:13px; }

  /* hide scrollbars */
  ::-webkit-scrollbar { width:0; height:0; }
</style>
</head>
<body>
<div id="app">
  <div id="frameWrap">
    <iframe id="pdfFrame" crossorigin="anonymous" sandbox="allow-scripts allow-forms"></iframe>

    <!-- Interaction catcher: we set pointer-events dynamically. When pointer-events='none' iframe is interactive.
         When we temporarily want to block middle-clicks or full-page interactions we set it to 'auto'. -->
    <div id="interactionCatcher"></div>

    <!-- toolbar mask (covers Dropbox toolbar area completely so it's not visible or clickable) -->
    <div id="toolbarMask" title="Protected content — toolbar hidden"></div>

    <!-- watermark overlay -->
    <div id="watermark" aria-hidden="true"></div>

    <!-- top controls -->
    <div id="controls">
      <button id="fullscreenBtn" class="ctrl">Enter Fullscreen</button>
      <button id="blockDownloadsBtn" class="ctrl">Block Downloads: ON</button>
      <button id="openFallback" class="ctrl">Open (if necessary)</button>
    </div>

    <div id="hint">Double-click top-left to hide controls</div>
  </div>
</div>

<script>
/* === Initialization and behavior === */
const frame = document.getElementById('pdfFrame');
const toolbarMask = document.getElementById('toolbarMask');
const interactionCatcher = document.getElementById('interactionCatcher');
const watermark = document.getElementById('watermark');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const blockDownloadsBtn = document.getElementById('blockDownloadsBtn');
const openFallbackBtn = document.getElementById('openFallback');
const controls = document.getElementById('controls');
const hint = document.getElementById('hint');

frame.src = IFRAME_SRC;

// set CSS custom props for mask size
document.documentElement.style.setProperty('--maskWpx', (typeof TOOLBAR_MASK_WIDTH_PX !== 'undefined' ? TOOLBAR_MASK_WIDTH_PX : 220) + 'px');
document.documentElement.style.setProperty('--maskHpx', (typeof TOOLBAR_MASK_HEIGHT_PX !== 'undefined' ? TOOLBAR_MASK_HEIGHT_PX : 72) + 'px');

// build watermark grid
function buildWatermark(text) {
  watermark.innerHTML = '';
  const w = window.innerWidth, h = window.innerHeight;
  const stepX = Math.max(260, Math.floor(w/5));
  const stepY = Math.max(150, Math.floor(h/6));
  for (let y = -stepY; y < h + stepY; y += stepY) {
    for (let x = -stepX; x < w + stepX; x += stepX) {
      const d = document.createElement('div');
      d.className = 'wmText';
      d.style.left = (x) + 'px';
      d.style.top = (y) + 'px';
      d.style.fontSize = Math.max(12, Math.floor(Math.min(w,h)/50)) + 'px';
      d.textContent = `${WATERMARK_BASE} — ${new Date().toLocaleString()}`;
      watermark.appendChild(d);
    }
  }
}
buildWatermark();
setInterval(buildWatermark, 30000);

// allow iframe interaction by default
let blockDownloads = true;
function applyBlocking() {
  if (blockDownloads) {
    // Catch middle-clicks and ctrl+clicks by overlaying a transparent element on the entire viewer
    interactionCatcher.style.pointerEvents = 'auto';
    interactionCatcher.oncontextmenu = (e) => { e.preventDefault(); };
    // intercept mouse buttons to block middle-click or ctrl+click attempts
    interactionCatcher.onmousedown = (e) => {
      // left click should let normal scroll/interaction pseudo-work by doing nothing and forwarding?
      // but for Dropbox we cannot forward into cross-origin iframe; to allow scroll we don't block wheel events
      // We'll block middle-click (button===1) and ctrl/meta + left-click (attempt to open in new tab)
      if (e.button === 1 || e.ctrlKey || e.metaKey) {
        e.preventDefault();
        e.stopPropagation();
        flashWatermark();
      }
    };
    // allow wheel events to pass through so scrolling works
    interactionCatcher.onwheel = (e) => {
      // Allow wheel to scroll iframe by temporarily letting pointer-events none while wheel is happening.
      interactionCatcher.style.pointerEvents = 'none';
      setTimeout(()=> { interactionCatcher.style.pointerEvents = 'auto'; }, 150);
    };
  } else {
    interactionCatcher.style.pointerEvents = 'none';
    interactionCatcher.oncontextmenu = null;
    interactionCatcher.onmousedown = null;
    interactionCatcher.onwheel = null;
  }
  blockDownloadsBtn.textContent = 'Block Downloads: ' + (blockDownloads ? 'ON' : 'OFF');
}
applyBlocking();

// flash watermark briefly as a deterrent
function flashWatermark() {
  watermark.style.transition = 'opacity 0.18s';
  watermark.style.opacity = '0.35';
  setTimeout(()=> watermark.style.opacity = '1', 250);
}

// prevent right-click anywhere on the page
document.addEventListener('contextmenu', e => { e.preventDefault(); }, {capture:true});
// block common save/print/devtools keys
window.addEventListener('keydown', (e) => {
  // block Save/Print/View Source/Devtools common combos
  if ((e.ctrlKey || e.metaKey) && ['s','p','u','S','U'].includes(e.key)) { e.preventDefault(); e.stopPropagation(); flashWatermark(); }
  if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','C','J'].includes(e.key.toUpperCase()))) { e.preventDefault(); e.stopPropagation(); flashWatermark(); }
  // block Ctrl+click & middle-click attempts (best-effort)
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); e.stopPropagation(); flashWatermark(); }
}, {capture:true});

// fullscreen control (user gesture required)
fullscreenBtn.addEventListener('click', async () => {
  try {
    if (!document.fullscreenElement) {
      await document.documentElement.requestFullscreen({ navigationUI: "hide" });
    } else {
      await document.exitFullscreen();
    }
  } catch (e) { console.warn('Fullscreen request failed', e); }
});

// toggle blocking mode (if you want to allow downloads temporarily)
blockDownloadsBtn.addEventListener('click', () => {
  blockDownloads = !blockDownloads;
  applyBlocking();
});

// open fallback — opens Dropbox in a new tab (useful for debugging). Note: user may download from there.
openFallbackBtn.addEventListener('click', () => {
  // open in new tab but set rel=noopener to avoid giving window reference
  window.open(IFRAME_SRC, '_blank', 'noopener,noreferrer');
});

// hide controls with dblclick top-left
let controlsVisible = true;
document.addEventListener('dblclick', (e) => {
  if (e.clientX < window.innerWidth * 0.45 && e.clientY < window.innerHeight * 0.35) {
    controlsVisible = !controlsVisible;
    controls.style.display = controlsVisible ? 'flex' : 'none';
    hint.style.display = controlsVisible ? 'block' : 'none';
  }
});

// when the page regains visibility (user returns), briefly flash watermark
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) flashWatermark();
});

// If user presses PrintScreen (some browsers don't fire key), we still try to flash watermark on keyup 'PrintScreen'
window.addEventListener('keyup', (e) => {
  if (e.key === 'PrintScreen' || e.keyCode === 44) flashWatermark();
});

// ensure iframe remains interactive for scrolling: we keep the interactionCatcher wheel hack above.
// When user clicks (left button), temporarily allow pointer events to reach iframe so they can click links inside preview if needed.
document.addEventListener('pointerdown', (e) => {
  // if left click inside central area, briefly allow pointer events except when blocking is on
  if (!blockDownloads && e.button === 0) {
    interactionCatcher.style.pointerEvents = 'none';
    setTimeout(()=> { if (blockDownloads) interactionCatcher.style.pointerEvents = 'auto'; }, 300);
  }
});

// responsive mask resizing
function adjustMask() {
  const w = Math.max(160, Math.floor(window.innerWidth * 0.18));
  const h = Math.max(64, Math.floor(window.innerHeight * 0.07));
  toolbarMask.style.width = w + 'px';
  toolbarMask.style.height = h + 'px';
}
window.addEventListener('resize', adjustMask);
adjustMask();

// final console note
console.info('Hardened Dropbox viewer loaded. Note: this only deters casual copying. For stronger protection use server-rendered images or DRM.');
</script>
</body>
</html>
