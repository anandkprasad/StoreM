<%- include('./partials/header') %>

<style>
  /* Admin form specific styles */
  body { 
    background:#f8f9fa; 
  }

  .card-admin { 
    border-radius:14px; 
    box-shadow:0 6px 20px rgba(10,20,40,0.04); 
    overflow:hidden; 
    background:#fff; 
  }
  
  .form-header { 
    margin-bottom: 30px; 
    text-align: center; 
  }
  .form-header h1 { 
    margin-bottom: 10px; 
  }
  
  .form-group label { 
    font-weight: 500; 
  }
  
  .preview-image { 
    max-width: 100%; 
    height: auto; 
    margin-top: 10px; 
    border-radius: 4px; 
    max-height: 300px; 
  }
  
  .btn-group-custom { 
    display: flex; 
    gap: 10px; 
    margin-top: 20px; 
  }
  .btn-group-custom button, 
  .btn-group-custom a { 
    flex: 1; 
  }

  .digital-badge {
    display: inline-block;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 20px;
  }

  @media (max-width: 991px) {
    .form-header h1 { 
      font-size: 1.3rem; 
    }
    .card-admin { 
      padding: 10px; 
    }
  }
</style>

<!-- Admin Form Content -->
<div class="card-admin p-4 mb-4">
  <div class="form-header">
    <h1><%= action === 'add' ? 'Add New Digital Product' : 'Edit Digital Product' %></h1>
    <p class="text-muted">Fill in the details below</p>
    <span class="digital-badge">
      <i class="fas fa-file-pdf mr-1"></i> Digital Product (PDF)
    </span>
  </div>
  
  <form method="POST" enctype="multipart/form-data">
    <!-- Hidden field to ensure product is always digital -->
    <input type="hidden" name="is_digital" value="true">

    <div class="form-group">
      <label for="name">Product Name *</label>
      <input type="text" class="form-control" id="name" name="name" value="<%= item?.name || '' %>" required placeholder="e.g., Complete JavaScript Guide">
    </div>

    <div class="form-group">
      <label for="description">Description *</label>
      <textarea class="form-control" id="description" name="description" rows="4" required placeholder="Describe your digital product..."><%= item?.description || '' %></textarea>
      <small class="form-text text-muted">Keep it under 250 characters for payment descriptions</small>
    </div>

    <div class="form-group">
      <label for="price">Price (â‚¹) *</label>
      <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" value="<%= item?.price || '' %>" required placeholder="0.00">
    </div>

    <div class="form-group">
      <label for="images">Product Images (choose multiple)</label>
      <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple onchange="previewImage(this)">
      <small class="form-text text-muted">Supported formats: JPG, PNG, GIF. Max size per file: 5MB. First image will be used as the primary thumbnail.</small>
      
      <% if (item && item.page_images && item.page_images.length) { %>
        <div style="margin-top: 15px;">
          <p><strong>Current Images:</strong></p>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <% item.page_images.forEach(function(img){ %>
              <img src="<%= img %>" alt="<%= item.name %>" class="preview-image" style="width:120px;height:auto;" />
            <% }) %>
          </div>
        </div>
      <% } else if (item && item.image_url) { %>
        <div style="margin-top: 15px;">
          <p><strong>Current Image:</strong></p>
          <img src="<%= item.image_url %>" alt="<%= item.name %>" class="preview-image">
        </div>
      <% } %>
      
      <div id="preview-container"></div>
    </div>

      <% if (action != 'edit') { %>
        <div class="form-group">
      <label for="pdf">PDF File *</label>
      <input type="file" class="form-control" id="pdf" name="pdf" accept=".pdf" <%= action === 'add' ? 'required' : '' %>>
      <small class="form-text text-muted">
        <i class="fas fa-info-circle"></i> Upload the digital product PDF. Max size: 50MB
      
      </small>
    <% } %>
    
     
    </div>

    <div class="btn-group-custom">
      <a href="/admin" class="btn btn-secondary">
        <i class="fas fa-times mr-1"></i> Cancel
      </a>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save mr-1"></i> <%= action === 'add' ? 'Add Product' : 'Update Product' %>
      </button>
    </div>
  </form>
</div>

<script>
  function previewImage(input) {
    const preview = document.getElementById('preview-container');
    preview.innerHTML = '';

    if (input.files && input.files.length) {
      const p = document.createElement('p');
      p.innerHTML = '<strong>New Image Preview:</strong>';
      p.style.marginTop = '15px';
      p.style.marginBottom = '8px';
      preview.appendChild(p);

      Array.from(input.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'preview-image';
          img.style.margin = '6px';
          img.style.width = '120px';
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    }
  }

  // Character counter for description
  const descTextarea = document.getElementById('description');
  if (descTextarea) {
    const charCounter = document.createElement('small');
    charCounter.className = 'form-text text-muted mt-1';
    charCounter.style.display = 'block';
    descTextarea.parentNode.appendChild(charCounter);
    
    function updateCharCount() {
      const length = descTextarea.value.length;
      charCounter.textContent = `${length} characters`;
      if (length > 250) {
        charCounter.classList.remove('text-muted');
        charCounter.classList.add('text-warning');
        charCounter.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${length} characters (recommended: under 250 for payment descriptions)`;
      } else {
        charCounter.classList.remove('text-warning');
        charCounter.classList.add('text-muted');
        charCounter.textContent = `${length} characters`;
      }
    }
    
    descTextarea.addEventListener('input', updateCharCount);
    updateCharCount();
  }
</script>

<%- include('./partials/footer') %>