<!-- views/flipbook-viewer.ejs -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipbook Viewer</title>

  <!-- jQuery required by turn.js — load jQuery first -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Turn.js (page flip) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js" integrity="" crossorigin="anonymous"></script>

  <style>
    html,body{height:100%;margin:0;background:#111;color:#fff;font-family:Inter,Arial}
    #container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:20px}
    #flipbook{width:90%;height:90%;max-width:1200px;max-height:900px;box-shadow:0 12px 40px rgba(0,0,0,0.6);background:#333}
    .page{width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .page img{max-width:100%;max-height:100%;user-select:none}
    #controls{position:fixed;left:18px;top:18px;z-index:60}
    button{padding:8px 10px;border-radius:6px;background:rgba(0,0,0,0.6);color:#fff;border:1px solid rgba(255,255,255,0.06)}
    /* watermark overlay */
    #watermark{position:fixed;inset:0;pointer-events:none;z-index:70;mix-blend-mode:overlay}
    .wmText{position:absolute;transform:rotate(-30deg);opacity:0.08;white-space:nowrap;color:#fff;font-size:16px}
  </style>
</head>
<body>
  <div id="container">
    <div id="flipbook"></div>
  </div>

  <div id="controls">
    <button id="prev">Prev</button>
    <button id="next">Next</button>
    <button id="fs">Fullscreen</button>
    <span id="pageno"></span>
  </div>

  <div id="watermark" aria-hidden="true"></div>

  <!-- safe viewer payload -->
  <script>
    // injected safely via EJS
    window.__VIEWER = {
      ORDER_ID: <%- JSON.stringify(orderId) %>,
      PAGES: <%- JSON.stringify(pagesCount) %>,
      TOKEN: <%- JSON.stringify(token) %>
    };
  </script>

  <!-- Safe JSON payload for user (avoid injecting directly into JS) -->
  <script type="application/json" id="__userData"><%- JSON.stringify(user || {}) %></script>

  <script>
    // Read server-injected values
    const ORDER_ID = window.__VIEWER.ORDER_ID;
    const PAGES = window.__VIEWER.PAGES;
    const TOKEN = window.__VIEWER.TOKEN;

    // Read user safely
    const USER = (function(){
      try {
        const el = document.getElementById('__userData');
        return el ? JSON.parse(el.textContent || '{}') : {};
      } catch (e) { console.warn('Failed to parse user JSON', e); return {}; }
    })();

    // Build image URL — replace with your endpoint pattern if different
    function imageUrl(page) {
      return '/secure/image/' + ORDER_ID + '/' + page + '?token=' + encodeURIComponent(TOKEN);
    }

    // Build flipbook pages
    const flipbook = document.getElementById('flipbook');
    for (let i = 1; i <= PAGES; i++) {
      const page = document.createElement('div');
      page.className = 'page';
      const img = document.createElement('img');
      img.src = imageUrl(i);
      img.alt = 'Page ' + i;
      // Block right click on image
      img.addEventListener('contextmenu', e => e.preventDefault());
      page.appendChild(img);
      flipbook.appendChild(page);
    }

    // Initialize turn.js (requires jQuery to be present)
    function initTurn(){
      // destroy if already initialized
      if ($(flipbook).data('turn')) $(flipbook).turn('destroy');
      $(flipbook).turn({
        width: flipbook.clientWidth,
        height: flipbook.clientHeight,
        autoCenter: true,
        display: 'single',
        acceleration: true
      });
    }

    // Init once window load fires
    window.addEventListener('load', () => {
      initTurn();

      // Prev/Next controls
      document.getElementById('prev').addEventListener('click', ()=> $(flipbook).turn('previous'));
      document.getElementById('next').addEventListener('click', ()=> $(flipbook).turn('next'));
      document.getElementById('fs').addEventListener('click', async ()=>{
        try { if(!document.fullscreenElement) await document.documentElement.requestFullscreen({navigationUI:'hide'}); else await document.exitFullscreen(); }
        catch(e){ console.warn(e); }
      });

      // Update pageno
      $(flipbook).bind('turned', function(event, page, view) {
        document.getElementById('pageno').innerText = page + '/' + PAGES;
      });
      document.getElementById('pageno').innerText = '1/' + PAGES;
    });

    // Watermark grid (client-side extra deterrent)
    function buildWatermark(text) {
      const wm = document.getElementById('watermark');
      wm.innerHTML = '';
      const w = window.innerWidth, h = window.innerHeight;
      const stepX = Math.max(260, Math.floor(w/5));
      const stepY = Math.max(150, Math.floor(h/6));
      for (let y = -stepY; y < h + stepY; y += stepY) {
        for (let x = -stepX; x < w + stepX; x += stepX) {
          const d = document.createElement('div');
          d.className = 'wmText';
          d.style.left = x + 'px';
          d.style.top = y + 'px';
          d.textContent = text;
          wm.appendChild(d);
        }
      }
    }

    const WM_TEXT_BASE = (USER && (USER.email || USER.name || USER.username)) ? (USER.email || USER.name || USER.username) : 'Purchased';
    const WM_TEXT = WM_TEXT_BASE + ' — order ' + ORDER_ID;
    buildWatermark(WM_TEXT);
    setInterval(()=> buildWatermark(WM_TEXT + ' — ' + new Date().toLocaleString()), 30000);

    // Keyboard nav
    window.addEventListener('keydown', e => {
      if (e.key === 'ArrowRight') $(flipbook).turn('next');
      if (e.key === 'ArrowLeft') $(flipbook).turn('previous');
      if ((e.ctrlKey || e.metaKey) && ['s','p','u'].includes(e.key)) { e.preventDefault(); }
    });

    // Prevent basic copy/drag behaviors from parent page
    ['selectstart','dragstart','copy','cut','paste'].forEach(evt => {
      document.addEventListener(evt, e => e.preventDefault(), {capture:true});
    });
  </script>
</body>
</html>
