<%- include('./partialsheader') %>

<style>
  /* Dashboard specific styles */
  body { 
    background:#f8f9fa; 
  }

  .dashboard-header { 
    padding: 22px 0; 
    margin-bottom: 18px; 
  }
  .dashboard-header h1 { 
    color: #222; 
    margin: 0; 
    font-size: 1.6rem; 
  }
  .subtle { 
    color: #6c757d; 
  }

  .nav-pills .nav-link { 
    border-radius: 8px; 
    padding: 10px 14px; 
  }
  .nav-pills .nav-link.active { 
    background: linear-gradient(90deg, #667eea, #764ba2); 
    color: #fff; 
    box-shadow: 0 8px 20px rgba(102,126,234,0.12); 
  }

  .shop-banner {
    background: linear-gradient(90deg, rgba(102,126,234,0.12), rgba(118,75,162,0.06));
    border-radius: 14px;
    padding: 26px;
    display:flex;
    align-items:center;
    gap:20px;
    box-shadow: 0 8px 28px rgba(15,30,70,0.03);
  }
  .shop-banner .cta {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    border-radius: 10px;
    padding: 12px 18px;
    font-weight:700;
    text-decoration:none;
  }

  .product-card { 
    border: none; 
    border-radius: 10px; 
    box-shadow: 0 6px 18px rgba(10,20,40,0.06); 
    transition: transform .18s, box-shadow .18s; 
    overflow:hidden; 
  }
  .product-card:hover { 
    transform: translateY(-6px); 
    box-shadow: 0 18px 40px rgba(10,20,40,0.08); 
  }
  .product-img { 
    height: 220px; 
    object-fit: cover; 
    width:100%; 
    display:block; 
  }
  .product-title { 
    font-weight: 600; 
    color: #222; 
    margin: 8px 0; 
  }
  .product-price { 
    color: #667eea; 
    font-size: 18px; 
    font-weight: 700; 
  }
  .btn-add-cart { 
    background: linear-gradient(135deg, #667eea, #764ba2); 
    border: none; 
    color: #fff; 
    width:100%; 
    border-radius: 8px; 
  }
  .btn-add-cart:hover { 
    opacity: 0.95; 
  }

  .table thead th { 
    background: #fff; 
  }
  .empty-message { 
    text-align:center; 
    padding:50px 20px; 
    color: #6c757d; 
  }
  .empty-message i { 
    font-size: 48px; 
    margin-bottom: 14px; 
    color:#dde2f6; 
  }

  @media (max-width: 991px){
    .product-img { 
      height: 180px; 
    }
    .shop-banner { 
      flex-direction: column; 
      text-align:center; 
    }
  }
</style>

<!-- Dashboard content container -->
<div class="container-fluid">
  <div class="dashboard-header d-flex align-items-center justify-content-between">
    <div>
      <h1>Dashboard</h1>
      <div class="subtle">Manage orders, view items and access purchases</div>
    </div>

    <!-- quick stats -->
    <div class="d-none d-md-flex align-items-center" style="gap:14px;">
      <div class="text-center">
        <div style="font-weight:800;font-size:1.2rem;"><%= items.length %></div>
        <div class="subtle small">Store items</div>
      </div>
      <div class="text-center">
        <div style="font-weight:800;font-size:1.2rem;"><%= (currentUser.orders || []).length %></div>
        <div class="subtle small">Orders</div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-pills mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item mr-2">
      <a class="nav-link active" id="overview-tab" data-toggle="pill" href="#overview" role="tab" aria-controls="overview" aria-selected="true">
        <i class="fas fa-tachometer-alt mr-1"></i> Overview
      </a>
    </li>
    <li class="nav-item mr-2">
      <a class="nav-link" id="products-tab" data-toggle="pill" href="#products" role="tab" aria-controls="products" aria-selected="false">
        <i class="fas fa-box-open mr-1"></i> Products
      </a>
    </li>
    <li class="nav-item mr-2">
      <a class="nav-link" id="account-tab" data-toggle="pill" href="#account" role="tab" aria-controls="account" aria-selected="false">
        <i class="fas fa-user-circle mr-1"></i> Account
      </a>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Overview -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="mb-3">
        <h4 class="mb-2">Your Order History</h4>
        <p class="subtle small mb-3">Access downloads for digital purchases and order details</p>

        <% if (success && success.length > 0) { %>
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            <%= success %>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
        <% } %>

        <% if (currentUser.orders && currentUser.orders.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="thead-light">
                <tr>
                  <th>Product</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th>Payment ID</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% currentUser.orders.forEach(function(order) { %>
                <tr>
                  <td>
                    <%= order.product && order.product.name ? order.product.name : 'Product' %>
                    <% if (order.product && order.product.is_digital) { %>
                      <span class="badge badge-info ml-2">Digital</span>
                    <% } %>
                  </td>
                  <td>₹ <%= order.amount %></td>
                  <td><%= new Date(order.createdAt).toLocaleString() %></td>
                  <td><%= order.paymentId %></td>
                  <td>
                    <% if (order.product && order.product.is_digital && order.product.pdf_url) { %>
                      <a href="/notes/<%= order._id %>/view" class="btn btn-sm btn-primary">
                        <i class="fas fa-book"></i> View
                      </a>
                    <% } else { %>
                      <span class="text-muted">—</span>
                    <% } %>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="alert alert-info">You have no orders yet.</div>
        <% } %>
      </div>
    </div>

    <!-- Products -->
    <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
      <div class="mb-4">
        <div class="shop-banner mb-4">
          <div style="flex:1;">
            <h3 style="margin:0; font-weight:800;">Discover curated ebooks — special offers inside</h3>
            <p class="subtle mb-0">High-quality PDFs & ePubs, instant delivery. Browse bestsellers, categories and exclusive deals.</p>
          </div>
          <div class="text-right">
            <a href="/shop" class="cta" role="button" aria-label="Shop Now">Shop Now <i class="fas fa-arrow-right ml-2"></i></a>
          </div>
        </div>

        <% if (!items || items.length === 0) { %>
          <div class="empty-message">
            <i class="fas fa-inbox"></i>
            <h4>No items available</h4>
            <p class="subtle">Check back soon for new ebooks. Meanwhile, explore the <a href="/shop">shop</a>.</p>
          </div>
        <% } else { %>
          <div class="row">
            <% items.forEach(function(item){ %>
              <div class="col-lg-3 col-md-6 mb-4 d-flex align-items-stretch">
                <div class="card product-card w-100">
                  <% if (item.image_url) { %>
                    <img src="<%= item.image_url %>" alt="<%= item.name %>" class="product-img">
                  <% } else { %>
                    <div class="product-img d-flex align-items-center justify-content-center" style="background:#f0f2ff;">
                      <i class="fas fa-book" style="font-size:48px;color:#c7d2fe;"></i>
                    </div>
                  <% } %>

                  <div class="card-body d-flex flex-column">
                    <h5 class="product-title"><%= item.name %></h5>
                    <p class="text-muted small" style="flex:1;"><%= (item.description || '').substring(0, 80) %><%= (item.description && item.description.length>80) ? '...' : '' %></p>
                    <div class="d-flex align-items-center">
                      <div class="product-price">₹ <%= Number(item.price).toFixed(2) %></div>
                    </div>
                    <div class="mt-3">
                      <form action="/cart/add/<%= item._id %>" method="POST">
                        <button type="submit" class="btn btn-add-cart">
                          <i class="fas fa-shopping-cart mr-1"></i> Add to cart
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Account -->
    <div class="tab-pane fade" id="account" role="tabpanel" aria-labelledby="account-tab">
      <div class="card mb-4" style="border-radius: 12px; box-shadow: 0 6px 18px rgba(10,20,40,0.04);">
        <div class="card-body">
          <h5 class="mb-2">Account details</h5>
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><strong>Name</strong></p>
              <p class="subtle"><%= currentUser.name %></p>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><strong>Email</strong></p>
              <p class="subtle"><%= currentUser.email %></p>
            </div>
          </div>
          <div class="mt-3">
            <a href="/account/edit" class="btn btn-outline-primary btn-sm">Edit profile</a>
          </div>
        </div>
      </div>

      <div class="mb-4">
        <h5>Saved purchases</h5>
        <p class="subtle small">Quick access to past downloads and receipts.</p>
        <% if (currentUser.orders && currentUser.orders.length>0) { %>
          <ul class="list-group">
            <% currentUser.orders.slice(0,5).forEach(function(order){ %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong><%= order.product && order.product.name ? order.product.name : 'Product' %></strong>
                  <div class="subtle small"><%= new Date(order.createdAt).toLocaleDateString() %></div>
                </div>
                <div class="text-right">
                  <span class="subtle small">₹ <%= order.amount %></span>
                </div>
              </li>
            <% }) %>
          </ul>
        <% } else { %>
          <div class="alert alert-light">No saved purchases.</div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
  // restore tab from hash and keep hash updated
  (function(){
    var hash = window.location.hash;
    if(hash) {
      var tabLink = document.querySelector('a[href="' + hash + '"]');
      if(tabLink) { $(tabLink).tab('show'); }
    }
    $('a[data-toggle="pill"]').on('shown.bs.tab', function (e) {
      history.replaceState(null, null, e.target.getAttribute('href'));
    });
  })();
</script>

<%- include('footer') %>