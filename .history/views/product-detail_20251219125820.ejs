<%- include('./partials/header') %>

<style>
  /* Product detail specific styles */
  .product-gallery { 
    background: linear-gradient(180deg,#fff,#fbfdff); 
    border-radius:16px; 
    box-shadow: 0 8px 30px rgba(21,30,60,0.08); 
    padding:18px; 
  }
  .product-gallery img { 
    width:100%; 
    height:100%; 
    object-fit:contain; 
    border-radius:12px; 
  }
  .price { 
    font-size:1.9rem; 
    font-weight:800; 
    color:#0b3a66; 
  }
  .buy-cta { 
    font-weight:700; 
    padding:12px 18px; 
    border-radius:12px; 
  }
  .specs { 
    background:#f8f9fb; 
    padding:12px; 
    border-radius:10px; 
  }
  .product-badges .badge { 
    margin-right:8px; 
    border-radius:10px; 
    padding:8px 10px; 
    font-weight:700; 
  }
  
  /* Recommended cards (consistent with index) */
  .rec-card { 
    border-radius:14px; 
    overflow:hidden; 
    transition:transform .18s ease, box-shadow .18s ease; 
    box-shadow:0 6px 20px rgba(10,20,40,0.04); 
  }
  .rec-card:hover { 
    transform:translateY(-6px); 
    box-shadow:0 22px 48px rgba(10,20,40,0.08); 
  }
  .rec-img { 
    height:220px; 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    background:linear-gradient(180deg,#fff,#fbfdff); 
  }
  .rec-img img { 
    width:100%; 
    height:100%; 
    object-fit:cover; 
    border-radius:12px; 
  }
  
  .muted { 
    color:#6c757d; 
  }

  @media (max-width:991px){
    .rec-img { 
      height:260px; 
    }
  }
</style>

<!-- Product detail -->
<div class="container-fluid py-3">
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="product-gallery">
        <% 
          const gallery = (product.page_images && product.page_images.length) ? product.page_images : (product.image_url ? [product.image_url] : []);
        %>
        <% if (gallery.length) { %>
          <div style="width:100%; height:420px; display:flex; align-items:center; justify-content:center;">
            <% if (gallery.length > 1) { %>
              <button id="prevBtn" type="button" style="background:none;border:none;font-size:34px;color:#333;margin-right:8px;">‹</button>
            <% } %>
            <img id="carouselImg" loading="lazy" src="<%= gallery[0] %>" alt="<%= product.name %>" style="max-width:100%; max-height:100%; object-fit:contain; border-radius:8px;" />
            <% if (gallery.length > 1) { %>
              <button id="nextBtn" type="button" style="background:none;border:none;font-size:34px;color:#333;margin-left:8px;">›</button>
            <% } %>
          </div>

          <% if (gallery.length > 1) { %>
            <div class="d-flex mt-3 gap-2" id="thumbs">
              <% gallery.forEach(function(img, idx){ %>
                <button class="thumb-btn" data-i="<%= idx %>" style="width:64px; height:64px; border-radius:8px; overflow:hidden; box-shadow:0 6px 18px rgba(10,20,40,0.04); cursor:pointer; border:none; background:transparent; padding:0;">
                  <img loading="lazy" src="<%= img %>" style="width:100%; height:100%; object-fit:cover;" alt="thumb-<%= idx %>">
                </button>
              <% }) %>
            </div>
          <% } %>
        <% } else { %>
          <div style="width:100%; height:420px; display:flex; align-items:center; justify-content:center;">
            <img loading="lazy" src="/img/product-1.jpg" alt="<%= product.name %>">
          </div>
        <% } %>
      </div>
    </div>

    <div class="col-md-6">
      <h2 class="mb-2" style="font-weight:800;"><%= product.name %></h2>

      <div class="product-badges mb-3">
        <% if (product.isNew) { %><span class="badge badge-pill badge-primary">NEW</span><% } %>
        <% if (product.isPrime) { %><span class="badge badge-pill badge-dark">PRIME</span><% } %>
        <% if (product.category) { %><span class="badge badge-pill badge-light text-dark"><%= product.category %></span><% } %>
      </div>

      <div class="mb-3">
        <div class="price">₹ <%= product.price %></div>
        <% if (product.original_price && product.original_price > product.price) { %>
        <% } %>
      </div>

      <p class="mb-3 muted" style="line-height:1.55;"><%= product.short_description || product.description || '' %></p>

      <div class="row mb-3">
        <div class="col-6">
          <div class="specs">
            <small class="muted">Format</small>
            <div><strong><%= product.format || 'ePub / PDF' %></strong></div>
          </div>
        </div>
      </div>

      <div class="d-flex align-items-center mb-4">
        <a href="/buy/<%= product._id %>" class="btn btn-success buy-cta mr-3" role="button" aria-label="Buy <%= product.name %> now">
          <i class="fa fa-bolt mr-1"></i> Buy Now
        </a>
      </div>

      <hr>

      <div>
        <h6 style="font-weight:700;">Product details</h6>
        <p class="muted" style="line-height:1.6;"><%= product.descriptionLong || product.description || 'No extra details provided.' %></p>
      </div>
    </div>
  </div>
</div>

<!-- Recommended -->
<% if (recommended && recommended.length > 0) { %>
  <div class="container-fluid py-4">
    <div class="text-center mb-4">
      <h3 class="section-title px-5"><span class="px-2">You May Also Like</span></h3>
    </div>

    <div class="row px-xl-5 pb-3">
      <% recommended.forEach(function(item) { %>
        <div class="col-lg-4 col-md-6 col-sm-12 mb-4 d-flex align-items-stretch">
          <div class="rec-card w-100 d-flex flex-column">
            <div class="rec-img">
              <img loading="lazy" src="<%= item.image_url || item.imageUrl || '/img/product-1.jpg' %>" alt="<%= item.name %>">
            </div>
            <div class="p-3 d-flex flex-column flex-grow-1">
              <a href="/product/<%= item._id %>" style="text-decoration:none;color:inherit;">
                <h5 style="font-size:1.05rem; font-weight:700; margin-bottom:8px;"><%= item.name %></h5>
              </a>
              <% if (item.author) { %>
                <div class="muted mb-2">by <strong><%= item.author %></strong></div>
              <% } %>

              <p class="muted mb-3" style="flex:1;">
                <% let words = (item.description || '').split(/\s+/); %>
                <%= words.slice(0, 20).join(' ') %><%= words.length > 20 ? '...' : '' %>
              </p>

              <div class="d-flex align-items-center">
                <div style="font-weight:800;">₹ <%= item.price %></div>
                <div class="ml-auto">
                  <a href="/product/<%= item._id %>" class="btn btn-primary btn-sm rounded-pill">Buy Now</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% }); %>
    </div>
  </div>
<% } %>

<%- include('./partials/footer') %>

<script>
  (function(){
    const gallery = <%- JSON.stringify((product.page_images && product.page_images.length) ? product.page_images : (product.image_url ? [product.image_url] : [])) %>;
    if (!gallery || !gallery.length) return;
    let idx = 0;
    const imgEl = document.getElementById('carouselImg');
    const prev = document.getElementById('prevBtn');
    const next = document.getElementById('nextBtn');
    const thumbs = document.querySelectorAll('.thumb-btn');

    function update() {
      imgEl.src = gallery[idx];
      thumbs.forEach(t => { if (t) t.style.outline = (Number(t.dataset.i) === idx) ? '2px solid #007bff' : 'none'; });
    }
    if (prev) prev.addEventListener('click', () => { idx = (idx - 1 + gallery.length) % gallery.length; update(); });
    if (next) next.addEventListener('click', () => { idx = (idx + 1) % gallery.length; update(); });
    thumbs.forEach(t => t.addEventListener('click', e => { idx = Number(e.currentTarget.dataset.i); update(); }));
  })();
</script>