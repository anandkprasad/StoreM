<!-- views/flipbook-viewer.ejs -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flipbook Viewer</title>

  <!-- jQuery required by turn.js — load jQuery first -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Turn.js (page flip) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4.1.0/turn.min.js" integrity="" crossorigin="anonymous"></script>

  <style>
    html,body{height:100%;margin:0;background:#111;color:#fff;font-family:Inter,Arial}
    #container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:20px}
    #flipbook{width:90%;height:90%;max-width:1200px;max-height:900px;box-shadow:0 12px 40px rgba(0,0,0,0.6);background:#333;overflow:hidden}
    .page{width:100%;height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .page img{max-width:100%;max-height:100%;user-select:none;-webkit-user-drag:none}
    #controls{position:fixed;left:18px;top:18px;z-index:60;display:flex;gap:8px;align-items:center}
    button{padding:8px 10px;border-radius:6px;background:rgba(0,0,0,0.6);color:#fff;border:1px solid rgba(255,255,255,0.06);cursor:pointer}
    #pageno{margin-left:8px;font-size:14px}
    /* watermark overlay */
    #watermark{position:fixed;inset:0;pointer-events:none;z-index:70;mix-blend-mode:overlay}
    .wmText{position:absolute;transform:rotate(-30deg);opacity:0.08;white-space:nowrap;color:#fff;font-size:16px}
    /* fallback iframe styling */
    #fallbackFrame { position:absolute; inset:0; width:100%; height:100%; border:0; background:#000; }
    /* hide image context menu on some browsers */
    img{ -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
  </style>
</head>
<body>
  <div id="container">
    <div id="flipbook" aria-hidden="true"></div>
    <!-- Fallback iframe hidden by default; shown only if pagesCount===0 -->
    <iframe id="fallbackFrame" style="display:none" title="PDF preview (fallback)"></iframe>
  </div>

  <div id="controls">
    <button id="prev">Prev</button>
    <button id="next">Next</button>
    <button id="fs">Fullscreen</button>
    <span id="pageno">0/0</span>
  </div>

  <div id="watermark" aria-hidden="true"></div>

  <!-- Safe viewer payload: use typeof checks so EJS doesn't break if a var is missing -->
  <script type="application/json" id="__viewerData">
    <%- JSON.stringify({
      orderId: (typeof orderId !== 'undefined' ? orderId : null),
      pagesCount: (typeof pagesCount !== 'undefined' ? pagesCount : 0),
      token: (typeof token !== 'undefined' ? token : null),
      pdfUrl: (typeof pdfUrl !== 'undefined' ? pdfUrl : null)
    }) %>
  </script>

  <!-- Safe JSON payload for user -->
  <script type="application/json" id="__userData"><%- JSON.stringify(user || {}) %></script>

  <script>
    // Read injected viewer payload safely
    const __viewerData = (function(){
      try {
        const el = document.getElementById('__viewerData');
        return el ? JSON.parse(el.textContent || '{}') : {};
      } catch (e) {
        console.warn('Failed to parse __viewerData', e);
        return {};
      }
    })();

    const ORDER_ID = __viewerData.orderId;
    const PAGES = Number(__viewerData.pagesCount) || 0;
    const TOKEN = __viewerData.token;
    const ORIGINAL_PDF_URL = __viewerData.pdfUrl || null;

    // Read user safely
    const USER = (function(){
      try {
        const el = document.getElementById('__userData');
        return el ? JSON.parse(el.textContent || '{}') : {};
      } catch (e) { console.warn('Failed to parse user JSON', e); return {}; }
    })();

    // Debug: confirm pdf url is available (remove in production)
    console.info('Flipbook viewer loaded. ORIGINAL_PDF_URL:', ORIGINAL_PDF_URL, 'PAGES:', PAGES);

    // Build image URL — adapt to your secure image endpoint if different
    function imageUrl(page) {
      return '/secure/image/' + encodeURIComponent(ORDER_ID) + '/' + encodeURIComponent(page) + '?token=' + encodeURIComponent(TOKEN);
    }

    // Utility: convert shared Dropbox page URL -> raw=1 (embed-ready)
    function toDropboxRaw(url) {
      if (!url) return null;
      try {
        const u = new URL(url);
        if (u.hostname.endsWith('dropbox.com')) {
          const rl = u.searchParams.get('rlkey');
          u.search = '';
          u.searchParams.set('raw','1');
          if (rl) u.searchParams.set('rlkey', rl);
          return u.toString();
        }
        return url;
      } catch (e) {
        // naive fallback
        const idx = url.indexOf('?');
        return (idx === -1) ? (url + '?raw=1') : (url.substring(0, idx) + '?raw=1');
      }
    }

    // Watermark builder
    function buildWatermark(text) {
      const wm = document.getElementById('watermark');
      wm.innerHTML = '';
      const w = window.innerWidth, h = window.innerHeight;
      const stepX = Math.max(240, Math.floor(w/5));
      const stepY = Math.max(140, Math.floor(h/6));
      for (let y = -stepY; y < h + stepY; y += stepY) {
        for (let x = -stepX; x < w + stepX; x += stepX) {
          const d = document.createElement('div');
          d.className = 'wmText';
          d.style.left = x + 'px';
          d.style.top = y + 'px';
          d.textContent = text;
          wm.appendChild(d);
        }
      }
    }

    const WM_ID = (USER && (USER.email || USER.username || USER.name)) ? (USER.email || USER.username || USER.name) : 'Purchased';
    const WM_TEXT = `${WM_ID} — order ${ORDER_ID || ''}`;

    // If pages were pre-generated (PAGES>0 and TOKEN present), show flipbook.
    // Otherwise show the Dropbox iframe fallback using the pdfUrl provided by server.
    if (PAGES > 0 && TOKEN) {
      // Build flipbook pages (images)
      const flipbook = document.getElementById('flipbook');
      for (let i = 1; i <= PAGES; i++) {
        const page = document.createElement('div');
        page.className = 'page';
        const img = document.createElement('img');
        img.src = imageUrl(i);
        img.alt = 'Page ' + i;
        // Block right click on the image element
        img.addEventListener('contextmenu', e => e.preventDefault());
        img.addEventListener('dragstart', e => e.preventDefault());
        page.appendChild(img);
        flipbook.appendChild(page);
      }

      // Initialize turn.js pageflip
      function initTurn(){
        try { if ($(flipbook).data('turn')) $(flipbook).turn('destroy'); } catch (e) {}
        $(flipbook).turn({
          width: flipbook.clientWidth,
          height: flipbook.clientHeight,
          autoCenter: true,
          display: 'single',
          acceleration: true
        });
      }

      // Wait for DOM + images loaded
      window.addEventListener('load', () => {
        initTurn();

        // Controls
        document.getElementById('prev').addEventListener('click', ()=> $(flipbook).turn('previous'));
        document.getElementById('next').addEventListener('click', ()=> $(flipbook).turn('next'));
        document.getElementById('fs').addEventListener('click', async ()=>{
          try { if (!document.fullscreenElement) await document.documentElement.requestFullscreen({ navigationUI: 'hide' }); else await document.exitFullscreen(); }
          catch(e){ console.warn('Fullscreen error', e); }
        });

        // Update page number on turned event
        $(flipbook).bind('turned', function(event, page, view) {
          document.getElementById('pageno').innerText = page + '/' + PAGES;
        });

        // initial pageno
        document.getElementById('pageno').innerText = '1/' + PAGES;
      });

      buildWatermark(WM_TEXT);
      setInterval(()=> buildWatermark(WM_TEXT + ' — ' + new Date().toLocaleString()), 30000);

      // keyboard nav & some blocking
      window.addEventListener('keydown', e => {
        if (e.key === 'ArrowRight') $(flipbook).turn('next');
        if (e.key === 'ArrowLeft') $(flipbook).turn('previous');
        if ((e.ctrlKey || e.metaKey) && ['s','p','u'].includes(e.key)) { e.preventDefault(); }
      });
    } else {
      // Fallback: show Dropbox iframe preview (raw=1). This is NOT secure (PDF bytes exposed).
      const fallback = document.getElementById('fallbackFrame');
      const flipbookEl = document.getElementById('flipbook');
      flipbookEl.style.display = 'none';
      const url = toDropboxRaw(ORIGINAL_PDF_URL || '');
      if (!url) {
        // Nothing to show
        fallback.style.display = 'none';
        document.getElementById('controls').style.display = 'none';
        document.body.innerHTML = '<div style="color:#fff;padding:24px">No content available.</div>';
      } else {
        fallback.style.display = 'block';
        fallback.src = url;
        // Hide controls because Dropbox frame has its own toolbar
        document.getElementById('controls').style.display = 'none';
        buildWatermark(WM_TEXT + ' — PREVIEW');
        setInterval(()=> buildWatermark(WM_TEXT + ' — PREVIEW — ' + new Date().toLocaleString()), 30000);
      }
    }

    // Prevent basic copy/drag behaviors from parent page
    ['selectstart','dragstart','copy','cut','paste'].forEach(evt => {
      document.addEventListener(evt, e => e.preventDefault(), {capture:true});
    });

    // prevent contextmenu at page level as extra precaution
    document.addEventListener('contextmenu', e => e.preventDefault(), {capture:true});
  </script>
</body>
</html>