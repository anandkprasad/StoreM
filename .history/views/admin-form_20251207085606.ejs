<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - <%= action === 'add' ? 'Add Item' : 'Edit Item' %> · EBookStore</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>

  <!-- Site CSS (keeps consistent look) -->
  <link href="/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">

  <style>
    :root{
      --accent-1: #667eea;
      --accent-2: #764ba2;
      --muted: #6c757d;
      --card-radius: 14px;
      --max-width: 1100px;
    }

    body{
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f6f8ff, #f8f9fb);
      color: #222;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .brand-badge{background:linear-gradient(135deg,var(--accent-1),#2aa0ff);border-radius:8px;padding:6px 10px;color:#fff;font-weight:700}
    .topbar{background:transparent}
    .btn-pill{border-radius:50px}

    .page-wrap { max-width: var(--max-width); margin: 28px auto; padding: 0 18px; }

    .admin-card {
      background: #fff;
      border-radius: var(--card-radius);
      box-shadow: 0 10px 30px rgba(21,30,60,0.06);
      overflow: hidden;
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 24px;
      padding: 26px;
    }
    @media (max-width: 991px) {
      .admin-card { grid-template-columns: 1fr; padding: 18px; }
    }

    .form-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 8px; }
    .form-title { font-size:1.25rem; font-weight:800; margin:0; }
    .breadcrumb { font-size:0.92rem; color:var(--muted); margin-bottom:14px; }

    .panel {
      background: linear-gradient(180deg,#fff,#fbfdff);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(10,20,40,0.03);
    }

    label { font-weight:600; color:#2b3340; }
    .form-control { border-radius: 10px; padding: 12px 14px; border: 1px solid #e6ecff; }
    textarea.form-control { min-height:120px; }

    .preview-image { width:100%; max-height:280px; object-fit:cover; border-radius:8px; display:block; margin-top:12px; box-shadow: 0 8px 24px rgba(15,30,80,0.04); }

    .small-muted { color:var(--muted); font-size:0.92rem; }

    .btn-primary-strong {
      background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
      border: none;
      color:#fff;
      padding:10px 18px;
      border-radius: 10px;
      box-shadow: 0 8px 20px rgba(102,126,234,0.12);
    }
    .btn-outline-muted { border-radius:10px; border:1px solid #e7eaf8; color:var(--muted); background:transparent; padding:9px 14px; }

    .meta-row { display:flex; gap:10px; align-items:center; justify-content:flex-start; margin-top:10px; flex-wrap:wrap; }

    .hint { background:#f7f8ff; border-radius:8px; padding:10px; color:var(--muted); font-size:0.92rem; }

    .field-label-row { display:flex; align-items:center; justify-content:space-between; gap:10px; }

    .file-help { font-size:0.9rem; color:#6f7aa6; }

    .actions { display:flex; gap:12px; margin-top:18px; }
    .actions .btn { min-width:120px; }

    .stats-row { display:flex; gap:12px; margin-bottom:12px; }
    .stats { flex:1; background:#fff; border-radius:10px; padding:10px; text-align:center; box-shadow:0 6px 14px rgba(10,20,40,0.03); }
    .stats strong { display:block; font-size:1.05rem; color:var(--accent-1); }

    .note { font-size:0.92rem; color:var(--muted); line-height:1.45; }
  </style>
</head>
<body>
  <!-- Topbar (index.ejs style) -->
  <div class="container-fluid topbar py-3">
    <div class="row align-items-center px-xl-5">
      <div class="col-lg-3 col-8 d-flex align-items-center">
        <a href="/" class="text-decoration-none d-flex align-items-center">
          <span class="brand-badge mr-3">E</span>
          <div>
            <h1 class="m-0 h5 font-weight-bold">EBookStore</h1>
            <small class="text-muted">Curated ebooks · instant access</small>
          </div>
        </a>
      </div>

      <div class="col-lg-6 col-12 mt-2 mt-lg-0">
        <form class="d-flex" action="/search" method="GET" role="search">
          <div class="input-group w-100">
            <input type="search" name="q" class="form-control" placeholder="Search for products, authors, ISBN..." aria-label="Search">
            <div class="input-group-append">
              <button class="btn btn-primary btn-pill" type="submit"><i class="fas fa-search"></i></button>
            </div>
          </div>
        </form>
      </div>

      <div class="col-lg-3 col-12 text-right mt-2 mt-lg-0 d-flex justify-content-end align-items-center">
        <div class="d-none d-lg-block">
          <% if (currentUser) { %>
            <a href="/dashboard" class="btn btn-outline-primary btn-pill mr-2">Hi, <%= currentUser.username || currentUser.name %></a>
            <a href="/logout" class="btn btn-primary btn-pill">Logout</a>
          <% } else { %>
            <a href="/login" class="btn btn-outline-primary btn-pill mr-2">Login</a>
            <a href="/signup" class="btn btn-primary btn-pill">Register</a>
          <% } %>
        </div>

        <div class="d-lg-none ml-2">
          <button class="btn btn-outline-secondary" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle menu">
            <i class="fas fa-user"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main page -->
  <div class="page-wrap">
    <div class="row gx-4">
      <div class="col-12">
        <div class="breadcrumb">
          <a href="/admin" class="small-muted">Admin</a> &nbsp; / &nbsp;
          <span><strong><%= action === 'add' ? 'Add Item' : 'Edit Item' %></strong></span>
        </div>
      </div>
    </div>

    <div class="admin-card" role="main" aria-labelledby="adminFormTitle">
      <!-- LEFT: form -->
      <div class="form-left">
        <div class="form-header">
          <div>
            <h2 id="adminFormTitle" class="form-title"><%= action === 'add' ? 'Add New Item' : 'Edit Item' %></h2>
            <div class="small-muted">Create or update an ebook listing</div>
          </div>

          <div class="meta-row">
            <a href="/admin" class="btn btn-outline-muted" title="Back to admin list"><i class="fas fa-chevron-left mr-1"></i> Back</a>

            <!-- preview button hidden when no item._id -->
            <a href="/product/<%= item && item._id ? item._id : '' %>"
               class="btn btn-outline-muted <%= item && item._id ? '' : 'd-none' %>"
               title="View product">
              <i class="fas fa-eye mr-1"></i> Preview
            </a>
          </div>
        </div>

        <div class="panel">
          <form method="POST" enctype="multipart/form-data" novalidate>
            <!-- Name -->
            <div class="form-group">
              <label for="name">Item Name *</label>
              <input id="name" name="name" class="form-control" required value="<%= item && item.name ? item.name : '' %>">
            </div>

            <!-- Description -->
            <div class="form-group">
              <label for="description">Description *</label>
              <textarea id="description" name="description" class="form-control" required><%= item && item.description ? item.description : '' %></textarea>
            </div>

            <div class="row">
              <div class="col-md-6">
                <!-- Price -->
                <div class="form-group">
                  <label for="price">Price (₹) *</label>
                  <input id="price" name="price" type="number" step="0.01" min="0" class="form-control" required value="<%= (item && (item.price !== undefined && item.price !== null)) ? item.price : '' %>">
                </div>
              </div>

              <div class="col-md-6">
                <!-- Category (optional) -->
                <div class="form-group">
                  <label for="category">Category</label>
                  <input id="category" name="category" class="form-control" value="<%= item && item.category ? item.category : '' %>">
                </div>
              </div>
            </div>

            <!-- Image -->
            <div class="form-group">
              <div class="field-label-row">
                <label for="image">Product Image</label>
                <div class="small-muted file-help">JPG, PNG — max 5MB</div>
              </div>
              <input type="file" id="image" name="image" class="form-control" accept="image/*" onchange="previewImage(this)">

              <% if (item && item.image_url) { %>
                <div style="margin-top:12px;">
                  <div class="small-muted">Current image</div>
                  <img src="<%= item.image_url %>" alt="<%= item.name %>" class="preview-image" />
                </div>
              <% } %>

              <div id="preview-container"></div>
            </div>

            <!-- Digital checkbox -->
            <div class="form-group">
              <div class="form-check">
                <input id="is_digital" name="is_digital" class="form-check-input" type="checkbox" value="true" <%= item && item.is_digital ? 'checked' : '' %> />
                <label class="form-check-label" for="is_digital">Digital Product (PDF)</label>
              </div>
              <div class="small-muted">If this item is digital, upload a PDF and mark pages if required.</div>
            </div>

            <!-- PDF upload -->
            <div id="pdf-upload-group" class="form-group <%= item && item.is_digital ? '' : 'd-none' %>">
              <div class="field-label-row">
                <label for="pdf">PDF File</label>
                <div class="small-muted file-help">PDF — max 50MB</div>
              </div>
              <input id="pdf" name="pdf" class="form-control" type="file" accept=".pdf">

              <% if (item && item.pdf_url) { %>
                <div style="margin-top:12px;">
                  <div class="small-muted">Current PDF</div>
                  <div class="hint">Uploaded — <%= item.page_images ? item.page_images.length : 0 %> pages converted</div>
                </div>
              <% } %>
            </div>

            <!-- Actions -->
            <div class="actions">
              <a class="btn btn-outline-muted" href="/admin">Cancel</a>
              <button type="submit" class="btn btn-primary-strong">
                <i class="fas fa-save mr-1"></i>
                <%= action === 'add' ? 'Add Item' : 'Update Item' %>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- RIGHT: help / stats / tips -->
      <aside class="form-right">
        <div class="panel" aria-hidden="false">
          <div class="stats-row">
            <div class="stats">
              <div class="small-muted">Items</div>
              <strong><%= (items || []).length %></strong>
            </div>
            <div class="stats">
              <div class="small-muted">Orders</div>
              <strong><%= (currentUser && currentUser.orders ? currentUser.orders.length : 0) %></strong>
            </div>
          </div>

          <h5 style="margin-top:6px;margin-bottom:10px;">Quick Tips</h5>
          <p class="note">
            • Use high-resolution cover images for better listings.<br/>
            • For digital products, upload a small sample first to verify conversion.<br/>
            • Keep price in rupees (₹) — use decimals for discounts.
          </p>

          <hr style="border:none;margin:14px 0;border-top:1px solid #eef2ff" />

          <h6 style="margin-bottom:8px;">File guidelines</h6>
          <ul class="small-muted" style="padding-left:18px;margin-bottom:12px;">
            <li>Images: JPG/PNG, max 5MB</li>
            <li>PDF: single file, max 50MB</li>
            <li>For best results, PDFs with searchable text convert faster</li>
          </ul>

          <div style="margin-top:12px;">
            <p style="margin-bottom:6px;font-weight:700;">Need help?</p>
            <a href="/contact" class="btn btn-outline-muted btn-block">Contact Support</a>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- JS (safe, waits for DOM) -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // image preview (exposed globally because onchange in markup calls it)
      window.previewImage = function(input) {
        var preview = document.getElementById('preview-container');
        if (!preview) return;
        preview.innerHTML = '';

        if (input && input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'preview-image';
            img.style.marginTop = '12px';
            var p = document.createElement('div');
            p.className = 'small-muted';
            p.style.marginTop = '8px';
            p.innerHTML = '<strong>New image preview</strong>';
            preview.appendChild(p);
            preview.appendChild(img);
          };
          reader.readAsDataURL(input.files[0]);
        }
      };

      // PDF show/hide logic
      var checkbox = document.getElementById('is_digital');
      var pdfGroup = document.getElementById('pdf-upload-group');
      var pdfInput = document.getElementById('pdf');

      function updatePdfVisibility() {
        if (!checkbox || !pdfGroup) return;
        if (checkbox.checked) {
          pdfGroup.classList.remove('d-none');
          if (pdfInput) pdfInput.required = true;
        } else {
          pdfGroup.classList.add('d-none');
          if (pdfInput) pdfInput.required = false;
        }
      }

      if (checkbox) {
        updatePdfVisibility();
        checkbox.addEventListener('change', updatePdfVisibility);
      }
    });
  </script>

  <!-- libraries -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
</body>
</html>
