<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure PDF Viewer — HTML-only (safe fallback)</title>

<style>
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  #viewer{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#050505;}
  .pageContainer{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;}
  canvas.pdfPage{max-width:100%;max-height:100%;background:#fff;pointer-events:none; image-rendering:optimizeQuality;}
  #watermark{position:absolute;inset:0;pointer-events:none;z-index:50;}
  .wmText{position:absolute;transform:rotate(-30deg);opacity:0.09;white-space:nowrap;user-select:none;font-size:18px;font-family:inherit;}
  #message{position:absolute;z-index:200;top:12px;left:12px;right:12px;text-align:left;color:#ddd;font-size:14px;}
  #errBox{position:absolute;bottom:12px;left:12px;width:calc(100% - 24px);background:rgba(0,0,0,0.6);padding:10px;border-radius:6px;color:#f88;display:none;z-index:210;}
  button { background:#222; color:#fff; border:1px solid #333; padding:8px 12px; border-radius:6px; cursor:pointer; }
  #openBtn { display:inline-block; margin-top:8px; }
  /* defensive UX */
  body,html{ -webkit-user-select:none; -moz-user-select:none; user-select:none; }
</style>
</head>
<body>
<div id="viewer" tabindex="0">
  <div class="pageContainer" id="pageContainer">
    <canvas id="pdfCanvas" class="pdfPage" aria-hidden="false"></canvas>
    <div id="watermark" aria-hidden="true"></div>
    <div id="message">Loading PDF…</div>
    <div id="errBox"></div>
  </div>
</div>

<!-- Load PDF.js (we load it dynamically below to attach onload safely) -->
<script>
/* ========== CONFIG ========== */
/* Put the direct URL to the PDF (must be hosted with CORS allowing your origin).
   If Dropbox blocks CORS (likely), the viewer will detect that and offer a safe "Open in new tab" fallback. */
const ORIGINAL_PDF_URL = "https://www.dropbox.com/scl/fi/fraizb3xwx6jcmd9307xq/693101df095ae9fd19fea697.pdf?rlkey=38p2ukkfqlrfcwfiv7itk4vob&raw=1";
const WATERMARK_BASE = "Purchased by: user@example.com — order #12345";
/* ========== end config ========== */

const message = document.getElementById('message');
const errBox = document.getElementById('errBox');
const watermark = document.getElementById('watermark');
const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');

let pdfDoc = null;
let pageNum = 1;

function createWatermark(text) {
  watermark.innerHTML = '';
  const w = window.innerWidth, h = window.innerHeight;
  const cols = Math.ceil(w/350)+2, rows = Math.ceil(h/180)+2;
  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      const d = document.createElement('div');
      d.className = 'wmText';
      d.style.left = (c*300) + 'px';
      d.style.top = (r*160) + 'px';
      d.style.fontSize = Math.max(12, Math.floor(Math.min(w,h)/60)) + 'px';
      d.textContent = text;
      watermark.appendChild(d);
    }
  }
}

function showError(msg, details) {
  console.error(msg, details);
  errBox.style.display = 'block';
  errBox.innerHTML = typeof msg === 'string' ? `<strong>${msg}</strong>` : `<strong>Error</strong>`;
  if (details) {
    const pre = document.createElement('pre');
    pre.style.whiteSpace = 'pre-wrap';
    pre.style.marginTop = '8px';
    pre.style.color = '#fbb';
    pre.textContent = (typeof details === 'string') ? details : (details.message || JSON.stringify(details));
    errBox.appendChild(pre);
  }
}

/* Render a PDF page to canvas (fit to screen) */
async function renderPage(pn, preferredScale=1.4) {
  try {
    const page = await pdfDoc.getPage(pn);
    const vp = page.getViewport({ scale: preferredScale });
    const maxW = window.innerWidth, maxH = window.innerHeight;
    const fitScale = Math.min(maxW / vp.width, maxH / vp.height, preferredScale);
    const view = page.getViewport({ scale: fitScale });
    canvas.width = Math.floor(view.width);
    canvas.height = Math.floor(view.height);
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    await page.render({ canvasContext: ctx, viewport: view }).promise;
    message.style.display = 'none';
  } catch (e) {
    showError('Page render failed', e);
  }
}

/* Try fetch->arrayBuffer then pdf.js; returns true if success */
async function tryFetchAndRender(url) {
  try {
    message.textContent = 'Attempting to fetch PDF (arrayBuffer) and render with PDF.js…';
    const resp = await fetch(url, { method:'GET', mode:'cors', cache:'no-store' });
    if (!resp.ok) throw new Error('Network response not OK: ' + resp.status);
    const ab = await resp.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise;
    createWatermark(WATERMARK_BASE + ' — ' + new Date().toLocaleString());
    await renderPage(pageNum);
    return true;
  } catch (err) {
    console.warn('fetch->arrayBuffer failed:', err);
    return false;
  }
}

/* Try pdfjs getDocument(url) fallback; returns true if success */
async function tryPdfJsUrl(url) {
  try {
    message.textContent = 'Trying direct PDF.js URL load (requires CORS on host)…';
    pdfDoc = await pdfjsLib.getDocument(url).promise;
    createWatermark(WATERMARK_BASE + ' — ' + new Date().toLocaleString());
    await renderPage(pageNum);
    return true;
  } catch (err) {
    console.warn('pdfjs.getDocument(url) failed:', err);
    return false;
  }
}

/* Safe fallback when CORS blocks: do NOT embed Dropbox using allow-same-origin+allow-scripts.
   Instead show a clear button to open the original PDF in a new tab (user can download / view there). */
function safeFallbackOpenNewTab(url) {
  message.textContent = 'Secure canvas rendering blocked by CORS. Use the button below to open the PDF in a new tab (less secure).';
  const btn = document.createElement('button');
  btn.id = 'openBtn';
  btn.textContent = 'Open PDF in new tab';
  btn.onclick = () => window.open(url, '_blank', 'noopener,noreferrer');
  errBox.style.display = 'block';
  errBox.innerHTML = '<strong>Fallback — CORS prevented secure canvas rendering.</strong><br/>Opening in a new tab is safer than embedding in an insecure iframe.';
  errBox.appendChild(btn);
  // Also show a short explanation in console
  console.info('CORS prevented fetch; to enable canvas rendering without a proxy, host the PDF on a server that sends Access-Control-Allow-Origin: * (or your origin). Examples: jsDelivr/GitHub, Netlify, S3 with CORS.');
}

/* Keyboard navigation + hardening */
window.addEventListener('keydown', (e) => {
  if (pdfDoc) {
    if (e.key === 'ArrowRight') { if (pageNum < pdfDoc.numPages) { pageNum++; renderPage(pageNum); } e.preventDefault(); }
    if (e.key === 'ArrowLeft') { if (pageNum > 1) { pageNum--; renderPage(pageNum); } e.preventDefault(); }
  }
});
window.addEventListener('contextmenu', e => e.preventDefault());
window.addEventListener('keydown', (e)=> {
  if ((e.ctrlKey || e.metaKey) && ['s','p','u','S','U'].includes(e.key)) { e.preventDefault(); }
  if (e.key === 'F12') e.preventDefault();
}, {capture:true});

/* Load PDF.js dynamically and only start after it's loaded so pdfjsLib is always defined */
(function loadPdfJsThenInit() {
  const script = document.createElement('script');
  script.src = 'https://unpkg.com/pdfjs-dist@3.11.172/build/pdf.min.js';
  script.onload = async () => {
    // configure worker
    if (typeof pdfjsLib === 'undefined') {
      showError('PDF.js loaded but pdfjsLib is not defined (unexpected).');
      return;
    }
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.172/build/pdf.worker.min.js';
    // Attempt client-only flows
    try {
      const ok1 = await tryFetchAndRender(ORIGINAL_PDF_URL);
      if (ok1) return;
      const ok2 = await tryPdfJsUrl(ORIGINAL_PDF_URL);
      if (ok2) return;
      // both failed: show safe fallback (open in new tab)
      safeFallbackOpenNewTab(ORIGINAL_PDF_URL);
    } catch (e) {
      showError('Initialization error', e);
    }
  };
  script.onerror = () => {
    showError('Failed to load PDF.js from CDN. Check network or CSP.');
  };
  document.head.appendChild(script);
})();
</script>
</body>
</html>
