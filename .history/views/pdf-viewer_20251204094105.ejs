<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure PDF Viewer — Debug</title>

<!-- PDF.js -->
<script src="https://unpkg.com/pdfjs-dist@3.11.172/build/pdf.min.js"></script>
<script>
  // worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.172/build/pdf.worker.min.js';
</script>

<style>
  html,body { height:100%; margin:0; background:#000; color:#fff; font-family:system-ui,Segoe UI,Roboto,Arial;}
  #viewer { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#111;}
  .pageContainer { position:relative; width:100vw; height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  canvas.pdfPage { max-width:100%; max-height:100%; width:auto; height:auto; background:#fff; pointer-events:none; }
  #message { position:absolute; z-index:200; top:12px; left:12px; right:12px; text-align:left; color:#eee; font-size:14px; }
  #errBox { position:absolute; bottom:12px; left:12px; right:12px; background:rgba(0,0,0,0.6); padding:10px; border-radius:6px; color:#f8b; display:none; }
  button { background:#222; color:#fff; border:1px solid #333; padding:6px 10px; border-radius:4px; cursor:pointer; }
  #watermark { position:absolute; inset:0; pointer-events:none; z-index:50; }
  .wmText { position:absolute; transform:rotate(-30deg); opacity:0.08; white-space:nowrap; user-select:none; font-size:18px; font-family:inherit;}
</style>
</head>
<body>
<div id="viewer" tabindex="0">
  <div class="pageContainer" id="pageContainer">
    <canvas id="pdfCanvas" class="pdfPage"></canvas>
    <div id="watermark" aria-hidden="true"></div>
    <div id="message">Loading... (check console for errors)</div>
    <div id="errBox"></div>
  </div>
</div>

<script>
const PDF_URL = "https://www.dropbox.com/scl/fi/fraizb3xwx6jcmd9307xq/693101df095ae9fd19fea697.pdf?rlkey=38p2ukkfqlrfcwfiv7itk4vob&raw=1";
// If you run a proxy on same domain, set PROXY_URL = '/pdf?url=' + encodeURIComponent(PDF_URL)
const PROXY_URL = ""; 

const canvas = document.getElementById('pdfCanvas');
const ctx = canvas.getContext('2d');
const message = document.getElementById('message');
const errBox = document.getElementById('errBox');
const watermark = document.getElementById('watermark');
let pdfDoc = null;
let pageNum = 1;

function showError(msg, extra) {
  console.error(msg, extra);
  errBox.style.display = 'block';
  errBox.textContent = (typeof msg === 'string') ? msg : JSON.stringify(msg);
  message.textContent = "Failed to load PDF — see error below and DevTools console.";
}

// create watermark simple
function createWatermark(text) {
  watermark.innerHTML = '';
  const w = window.innerWidth, h = window.innerHeight;
  const cols = Math.ceil(w/350) + 1, rows = Math.ceil(h/200)+1;
  for (let r=0;r<rows;r++){
    for (let c=0;c<cols;c++){
      const d = document.createElement('div');
      d.className = 'wmText';
      d.style.left = (c*300) + 'px';
      d.style.top = (r*160) + 'px';
      d.textContent = text;
      watermark.appendChild(d);
    }
  }
}

async function renderPage(pn, scaleCandidate=1.5) {
  if (!pdfDoc) return;
  const page = await pdfDoc.getPage(pn);
  // compute scale to fit viewport
  const viewport = page.getViewport({ scale: scaleCandidate });
  const maxW = window.innerWidth, maxH = window.innerHeight;
  const fitScale = Math.min(maxW/viewport.width, maxH/viewport.height, scaleCandidate);
  const view = page.getViewport({ scale: fitScale });
  canvas.width = Math.floor(view.width);
  canvas.height = Math.floor(view.height);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  await page.render({ canvasContext: ctx, viewport: view }).promise;
  message.style.display = 'none';
}

// Try to load using fetch->blob->arrayBuffer first (best), else fallback to getDocument with URL
async function loadPdf(url) {
  const target = PROXY_URL ? (PROXY_URL + encodeURIComponent(url)) : url;
  try {
    // try fetch as ArrayBuffer
    const resp = await fetch(target, { method:'GET', mode:'cors', cache:'no-store' });
    if (!resp.ok) throw new Error('Fetch failed: ' + resp.status);
    // read as arrayBuffer
    const ab = await resp.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({ data: ab }).promise;
    createWatermark("Purchased by: user@example.com — " + new Date().toLocaleString());
    await renderPage(pageNum);
    return;
  } catch (errFetch) {
    console.warn("fetch->arrayBuffer failed:", errFetch);
    // fallback: try letting PDF.js fetch the URL itself (sometimes works if CORS present)
    try {
      pdfDoc = await pdfjsLib.getDocument(target).promise;
      createWatermark("Purchased by: user@example.com — " + new Date().toLocaleString());
      await renderPage(pageNum);
      return;
    } catch (errPDFURL) {
      // both methods failed
      showError("Both fetch and PDF.js URL loading failed. Likely a CORS restriction or blocked response.", { fetchErr: errFetch, pdfUrlErr: errPDFURL });
      // show console hints
      console.error("Detailed errors:", { fetchErr, errPDFURL });
    }
  }
}

// keyboard nav + basic hardening
window.addEventListener('keydown', (e)=>{
  if (e.key === 'ArrowRight') { if (pdfDoc && pageNum < pdfDoc.numPages) { pageNum++; renderPage(pageNum); } e.preventDefault();}
  if (e.key === 'ArrowLeft') { if (pdfDoc && pageNum > 1) { pageNum--; renderPage(pageNum);} e.preventDefault(); }
});

// initialize
(async function init(){
  createWatermark("Purchased by: user@example.com — " + new Date().toLocaleString());
  try {
    await loadPdf(PDF_URL);
  } catch (e) {
    showError("Unexpected init error", e);
  }
})();
</script>
</body>
</html>
