<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure Flipbook — StoreM</title>

<script>
  // server will inject these values when rendering
  const ORDER_ID = "<%= orderId %>";
  const VIEW_TOKEN = "<%= (typeof token !== 'undefined' ? token : '') %>"; // optional token rendered by your route
  const WATERMARK_BASE = "Purchased by: <%= (user && user.email) ? user.email : 'Guest' %>";
</script>

<style>
  :root { --bg:#000; --wm-opacity:0.08; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#fff}
  #app{position:fixed;inset:0;display:flex;align-items:stretch;justify-content:center;background:#000}
  #frameWrap{position:relative;flex:1;overflow:hidden;background:#000}
  /* image viewer replaces iframe */
  #imageViewer { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
  #imageViewer img { max-width:100%; max-height:100%; display:block; box-shadow: 0 6px 24px rgba(0,0,0,0.6); user-select: none; -webkit-user-drag: none; }
  /* opaque toolbar mask (covers toolbar area) */
  #toolbarMask{position:absolute;top:0;right:0;z-index:60;background:rgba(0,0,0,0.98);pointer-events:auto;
    width:var(--maskWpx);height:var(--maskHpx);border-bottom-left-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.75);}
  /* watermark overlay */
  #watermark{position:absolute;inset:0;z-index:70;pointer-events:none;overflow:hidden}
  .wmText{position:absolute;transform:rotate(-30deg);opacity:var(--wm-opacity);white-space:nowrap;user-select:none;font-size:18px;color:#fff}
  /* controls */
  #controls{position:absolute;left:12px;top:12px;z-index:80;display:flex;gap:8px;align-items:center}
  button.ctrl{background:rgba(0,0,0,0.6);color:#fff;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:6px;cursor:pointer;font-size:13px}
  #status{position:absolute;left:12px;bottom:12px;z-index:80;color:#ddd;background:rgba(0,0,0,0.4);padding:6px 8px;border-radius:6px;font-size:13px}
  ::-webkit-scrollbar{width:0;height:0}
</style>
</head>
<body>
<div id="app">
  <div id="frameWrap">
    <div id="imageViewer">
      <img id="pageImg" src="" alt="page image" />
    </div>

    <!-- toolbar mask covers buttons and blocks clicks on that small area -->
    <div id="toolbarMask" title="Protected content — toolbar hidden"></div>

    <!-- watermark overlay -->
    <div id="watermark" aria-hidden="true"></div>

    <div id="controls">
      <button id="prevBtn" class="ctrl">Prev</button>
      <button id="nextBtn" class="ctrl">Next</button>
      <button id="fullscreenBtn" class="ctrl">Toggle Fullscreen</button>
    </div>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure PDF Viewer — StoreM</title>
  <style>
    html,body{height:100%;margin:0;background:#111;color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    #viewer { position:fixed; inset:0; display:flex; flex-direction:column; }
    #toolbar { display:flex; gap:8px; padding:8px; background:#0f0f0faa; align-items:center }
    button { padding:8px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.6); color:#fff; cursor:pointer }
    #canvasWrap { flex:1; overflow:auto; display:flex; align-items:center; justify-content:center; background:#000 }
    canvas { box-shadow:0 6px 30px rgba(0,0,0,0.6); }
    #watermark{position:absolute;inset:0;pointer-events:none;opacity:0.08;color:#fff}
  </style>
  <!-- PDF.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    const PRODUCT_ID = "<%= productId %>";
    const VIEW_TOKEN = "<%= (typeof token !== 'undefined' ? token : '') %>";
    const WATERMARK_BASE = "Purchased by: <%= (user && user.email) ? user.email : 'Guest' %>";
  </script>
</head>
<body>
  <div id="viewer">
    <div id="toolbar">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <button id="zoomOut">-</button>
      <button id="zoomIn">+</button>
      <span id="status">Loading...</span>
      <div style="flex:1"></div>
      <button id="fullscreen">Fullscreen</button>
    </div>
    <div id="canvasWrap">
      <canvas id="pdfCanvas"></canvas>
      <div id="watermark" aria-hidden="true"></div>
    </div>
  </div>

  <script>
    // PDF.js worker
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const canvas = document.getElementById('pdfCanvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');
    const watermark = document.getElementById('watermark');

    let pdfDoc = null;
    let currentPage = 1;
    let scale = 1.2;

    function buildWatermark(){
      watermark.innerHTML = '';
      const w = window.innerWidth, h = window.innerHeight;
      const stepX = Math.max(260, Math.floor(w/5));
      const stepY = Math.max(150, Math.floor(h/6));
      for (let y = -stepY; y < h + stepY; y += stepY){
        for (let x = -stepX; x < w + stepX; x += stepX){
          const d = document.createElement('div');
          d.style.position='absolute'; d.style.left = x+'px'; d.style.top = y+'px'; d.style.transform='rotate(-30deg)';
          d.style.opacity='0.08'; d.style.whiteSpace='nowrap'; d.style.color='#fff'; d.textContent = `${WATERMARK_BASE} — ${new Date().toLocaleString()}`;
          watermark.appendChild(d);
        }
      }
    }
    buildWatermark(); setInterval(buildWatermark, 30000);

    // Prevent download/print shortcuts and right-click
    document.addEventListener('contextmenu', e => e.preventDefault(), {capture:true});
    window.addEventListener('keydown', (e)=>{
      if ((e.ctrlKey || e.metaKey) && ['s','p','S'].includes(e.key)) { e.preventDefault(); e.stopPropagation(); }
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','C','J'].includes(e.key.toUpperCase()))) { e.preventDefault(); e.stopPropagation(); }
    }, {capture:true});

    async function fetchPdfArrayBuffer(){
      const tokenParam = VIEW_TOKEN ? `?token=${encodeURIComponent(VIEW_TOKEN)}` : '';
      const url = `/pdf/${PRODUCT_ID}${tokenParam}`;
      const resp = await fetch(url, { method: 'GET', credentials: 'same-origin' });
      if (!resp.ok) throw new Error('Failed to fetch PDF');
      return await resp.arrayBuffer();
    }

    async function loadPdf(){
      status.textContent = 'Loading PDF...';
      try {
        const ab = await fetchPdfArrayBuffer();
        const loadingTask = pdfjsLib.getDocument({ data: ab });
        pdfDoc = await loadingTask.promise;
        status.textContent = `Pages: ${pdfDoc.numPages}`;
        renderPage(currentPage);
      } catch (err) {
        console.error('PDF load error', err);
        status.textContent = 'Unable to load PDF';
      }
    }

    async function renderPage(pageNum){
      status.textContent = `Rendering ${pageNum}/${pdfDoc.numPages}`;
      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale });
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const renderContext = { canvasContext: ctx, viewport };
      await page.render(renderContext).promise;
      status.textContent = `Page ${pageNum} / ${pdfDoc.numPages}`;
    }

    document.getElementById('prev').addEventListener('click', ()=>{ if (currentPage>1){ currentPage--; renderPage(currentPage); } });
    document.getElementById('next').addEventListener('click', ()=>{ if (currentPage < pdfDoc.numPages){ currentPage++; renderPage(currentPage); } });
    document.getElementById('zoomIn').addEventListener('click', ()=>{ scale = Math.min(3, scale + 0.2); renderPage(currentPage); });
    document.getElementById('zoomOut').addEventListener('click', ()=>{ scale = Math.max(0.4, scale - 0.2); renderPage(currentPage); });
    document.getElementById('fullscreen').addEventListener('click', async ()=>{ try{ if (!document.fullscreenElement) await document.documentElement.requestFullscreen({ navigationUI: 'hide' }); else await document.exitFullscreen(); }catch(e){console.warn(e);} });

    // cleanup beacon - no-op for PDF-only flow but keep parity
    window.addEventListener('beforeunload', ()=>{ try{ const url = `/notes/${PRODUCT_ID}/cleanup-pages`; if (navigator.sendBeacon) navigator.sendBeacon(url, new Blob([], {type:'application/octet-stream'})); }catch(e){} });

    loadPdf();
  </script>
</body>
</html>
