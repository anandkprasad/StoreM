<!-- views/pdf-viewer.ejs -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDF Viewer</title>
<style>
  :root { --bg:#000; --wm-opacity:0.08; }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#fff}
  #app{position:fixed;inset:0;display:flex;align-items:stretch;justify-content:center;background:#000}
  #frameWrap{position:relative;flex:1;overflow:hidden;background:#000}
  iframe#pdfFrame{position:absolute;inset:0;width:100%;height:100%;border:0;background:#111;pointer-events:auto;}

  /* opaque top-right mask to hide Dropbox toolbar */
  #toolbarMask{position:absolute;top:0;right:0;z-index:60;background:rgba(0,0,0,0.98);
    pointer-events:auto;width:var(--maskWpx);height:var(--maskHpx);border-bottom-left-radius:12px;
    box-shadow:0 8px 30px rgba(0,0,0,0.75);}

  /* interaction blocker sits above iframe to block clicks but below watermark */
  #interactionBlocker {
    position: absolute;
    inset: 0;
    z-index: 65;               /* above iframe & toolbarMask, below watermark */
    background: transparent;
    pointer-events: auto;      /* captures clicks */
    -webkit-tap-highlight-color: transparent;
  }

  #watermark{position:absolute;inset:0;z-index:70;pointer-events:none;overflow:hidden}
  .wmText{position:absolute;transform:rotate(-30deg);opacity:var(--wm-opacity);white-space:nowrap;user-select:none;font-size:18px;color:#fff}
  #controls{position:absolute;left:12px;top:12px;z-index:80;display:flex;gap:8px;align-items:center}
  button.ctrl{background:rgba(0,0,0,0.6);color:#fff;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:6px;cursor:pointer;font-size:13px}
  #hint{position:absolute;right:12px;top:12px;z-index:80;color:#ddd;background:rgba(0,0,0,0.4);padding:6px 8px;border-radius:6px;font-size:13px}
  ::-webkit-scrollbar{width:0;height:0}
</style>
</head>
<body>
<div id="app">
  <div id="frameWrap">
    <iframe id="pdfFrame" title="PDF viewer"></iframe>

    <!-- opaque toolbar mask -->
    <div id="toolbarMask" title="Content protected — toolbar hidden"></div>

    <!-- interaction blocker (blocks right-click / open-in-new-tab / save-as) -->
    <div id="interactionBlocker" title="Protected content — interactions limited"></div>

    <!-- watermark overlay -->
    <div id="watermark" aria-hidden="true"></div>

    <div id="controls">
      <button id="fullscreenBtn" class="ctrl">Enter Fullscreen</button>
    </div>

    <div id="hint">Double-click top-left to hide controls</div>
  </div>
</div>

<!-- Safe JSON payload for user -->
<script type="application/json" id="__userData"><%- JSON.stringify(user || {}) %></script>

<script>
  // Server values
  const ORIGINAL_PDF_URL = "<%= (pdfUrl || '') %>";
  const USER = (function(){ try { const el = document.getElementById('__userData'); return el ? JSON.parse(el.textContent || '{}') : {}; } catch(e){ return {}; }})();
  const ORDER_ID = "<%= (orderId || '') %>";

  function toDropboxRaw(url) {
    if (!url) return url;
    try {
      const u = new URL(url);
      if (u.hostname.endsWith('dropbox.com')) {
        const rl = u.searchParams.get('rlkey');
        u.search = '';
        u.searchParams.set('raw','1');
        if (rl) u.searchParams.set('rlkey', rl);
        return u.toString();
      }
      return url;
    } catch (e) {
      if (url.includes('dropbox.com')) {
        const idx = url.indexOf('?');
        if (idx === -1) return url + '?raw=1';
        return url.substring(0, idx) + '?raw=1';
      }
      return url;
    }
  }

  function makeWatermarkBase() {
    let id = '';
    if (USER && (USER.email || USER.username || USER.name)) id = USER.email || USER.username || USER.name;
    else id = 'Purchased';
    return `${id} — order ${ORDER_ID || ''}`;
  }

  const IFRAME_SRC = toDropboxRaw(ORIGINAL_PDF_URL);
  const WATERMARK_BASE = makeWatermarkBase();

  // DOM refs
  const frame = document.getElementById('pdfFrame');
  const toolbarMask = document.getElementById('toolbarMask');
  const interactionBlocker = document.getElementById('interactionBlocker');
  const watermark = document.getElementById('watermark');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const controls = document.getElementById('controls');
  const hint = document.getElementById('hint');

  // load iframe
  frame.src = IFRAME_SRC;

  // mask sizing
  function adjustMask(){
    const w = Math.max(220, Math.floor(window.innerWidth * 0.22));
    const h = Math.max(80, Math.floor(window.innerHeight * 0.08));
    toolbarMask.style.width = w + 'px';
    toolbarMask.style.height = h + 'px';
    document.documentElement.style.setProperty('--maskWpx', w + 'px');
    document.documentElement.style.setProperty('--maskHpx', h + 'px');
  }
  window.addEventListener('resize', adjustMask);
  adjustMask();

  // watermark builder
  function buildWatermark() {
    watermark.innerHTML = '';
    const w = window.innerWidth, h = window.innerHeight;
    const stepX = Math.max(240, Math.floor(w/5));
    const stepY = Math.max(140, Math.floor(h/6));
    for (let y = -stepY; y < h + stepY; y += stepY) {
      for (let x = -stepX; x < w + stepX; x += stepX) {
        const d = document.createElement('div');
        d.className = 'wmText';
        d.style.left = (x) + 'px';
        d.style.top = (y) + 'px';
        d.style.fontSize = Math.max(12, Math.floor(Math.min(w,h)/50)) + 'px';
        d.textContent = `${WATERMARK_BASE} — ${new Date().toLocaleString()}`;
        watermark.appendChild(d);
      }
    }
  }
  buildWatermark();
  setInterval(buildWatermark, 30000);

  // block keyboard shortcuts at page level
  document.addEventListener('contextmenu', e => e.preventDefault(), {capture:true});
  window.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && ['s','p','u','S','U'].includes(e.key)) { e.preventDefault(); e.stopPropagation(); flashWatermark(); }
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','C','J'].includes(e.key.toUpperCase()))) { e.preventDefault(); e.stopPropagation(); flashWatermark(); }
  }, {capture:true});

  function flashWatermark() {
    watermark.style.transition = 'opacity 0.18s';
    watermark.style.opacity = '0.35';
    setTimeout(()=> watermark.style.opacity = '1', 250);
  }

  // fullscreen
  fullscreenBtn.addEventListener('click', async () => {
    try {
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen({ navigationUI: "hide" });
      else await document.exitFullscreen();
    } catch (e) { console.warn('Fullscreen failed', e); }
  });

  // hide controls dblclick
  let controlsVisible = true;
  document.addEventListener('dblclick', (e) => {
    if (e.clientX < window.innerWidth * 0.45 && e.clientY < window.innerHeight * 0.35) {
      controlsVisible = !controlsVisible;
      controls.style.display = controlsVisible ? 'flex' : 'none';
      hint.style.display = controlsVisible ? 'block' : 'none';
    }
  });

  // detect printscreen / visibility
  document.addEventListener('visibilitychange', () => { if (!document.hidden) flashWatermark(); });
  window.addEventListener('keyup', (e) => { if (e.key === 'PrintScreen' || e.keyCode === 44) flashWatermark(); });

  // focus iframe on load
  frame.addEventListener('load', () => { try { frame.contentWindow.focus(); } catch (e) {} });

  // ---------------------------
  // Improved interaction-blocker logic
  // ---------------------------
  // Goals:
  // - block right-click, middle-click, ctrl+click on the iframe where possible
  // - preserve smooth wheel/touch scrolling by immediately dropping pointer-events to the iframe during scroll/touch
  // - re-enable blocking shortly after scroll/touch stops

  // Debounced helpers
  let wheelTimer = null;
  function onWheelStart() {
    // immediately let iframe receive pointer events
    interactionBlocker.style.pointerEvents = 'none';
    try { frame.contentWindow && frame.contentWindow.focus(); } catch(e){}
    clearTimeout(wheelTimer);
    wheelTimer = setTimeout(() => {
      interactionBlocker.style.pointerEvents = 'auto';
    }, 200); // re-enable after 200ms of idle wheel
  }

  // touch: allow slightly longer to accommodate touch scrolling
  let touchTimer = null;
  function onTouchStart() {
    interactionBlocker.style.pointerEvents = 'none';
    try { frame.contentWindow && frame.contentWindow.focus(); } catch(e){}
    clearTimeout(touchTimer);
    touchTimer = setTimeout(() => {
      interactionBlocker.style.pointerEvents = 'auto';
    }, 300);
  }

  // block contextmenu via blocker (captures attempts)
  interactionBlocker.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    flashWatermark();
  }, {passive:false});

  // block mousedown aux clicks (middle button) and ctrl/meta + left-click
  interactionBlocker.addEventListener('mousedown', (e) => {
    // If it's a primary click (left button) and not ctrl/meta, let it pass through by temporarily disabling blocker
    // so users can click links in iframe if necessary. We only block middle-click or ctrl/meta combos.
    if (e.button === 1 || e.ctrlKey || e.metaKey) {
      e.preventDefault();
      e.stopPropagation();
      flashWatermark();
      // keep blocker active
    } else {
      // for left-click, allow a very short pass-through so clicks behave normally
      interactionBlocker.style.pointerEvents = 'none';
      setTimeout(()=> {
        // re-enable soon after the click to keep protections
        if (!wheelTimer) interactionBlocker.style.pointerEvents = 'auto';
      }, 120);
    }
  }, {passive:false});

  // Allow wheel/touch to pass by dropping blocker immediately into none
  interactionBlocker.addEventListener('wheel', (e) => {
    onWheelStart();
    // let iframe handle scrolling
  }, {passive:true});

  interactionBlocker.addEventListener('touchstart', (e) => {
    onTouchStart();
  }, {passive:true});

  // also listen at document level for auxiliary clicks as a fallback
  document.addEventListener('auxclick', (e) => {
    // auxclick fired outside the blocker may open new tab; if it's middle click we flash watermark
    if (e.button === 1) { e.preventDefault(); flashWatermark(); }
  }, {capture:true});

  // Prevent drag/select from parent
  ['selectstart','dragstart','copy','cut','paste'].forEach(evt => document.addEventListener(evt, e => e.preventDefault(), {capture:true}));

  console.info('Final hardened Dropbox viewer loaded (improved scroll behavior). Note: OS-level screenshots remain possible.');
</script>
</body>
</html>
